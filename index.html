<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Gantt Online</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

  <script src="codebase/dhtmlxgantt.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://export.dhtmlx.com/gantt/api.js"></script>

  <link rel="stylesheet" href="codebase/dhtmlxgantt.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <style type="text/css">
    html, body { height:100%; padding:0px; margin:0px; overflow: hidden; }
  </style>
</head>
<body>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
        integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>

  <div>
    <div class="row align-items-center">
      <div class="col-md-4">
        <!-- Load data -->
        <div class="row align-items-center">
          <a class="font-weight-light" style="margin-left: 40px">Load</a>
          <label class="custom-file" style="margin-left: 10px">
            <input type="file" id="load_file" class="custom-file-input">
            <span class="custom-file-control"></span>
          </label>
        </div>
      </div>
      <div class="col-md-8">
        <!-- Export data -->
        <input value="Export to PNG" type="button" onclick='gantt.exportToPNG()' class="btn btn-primary" style='margin:10px;'>
        <input value="Export to PDF" type="button" onclick='gantt.exportToPDF()' class="btn btn-primary" style='margin:10px;'>
        <input value="Export to Excel" type="button" onclick='gantt.exportToExcel()' class="btn btn-primary" style='margin:10px;'>
        <input value="Export to iCal" type="button" onclick='gantt.exportToICal()' class="btn btn-primary" style='margin:10px;'>
        <button id="save" class="btn btn-primary" style='margin:10px;'>Save</button>
        <a download="gantt.json" id="download_json" class="btn btn-success" style="display: none">Download</a>
      </div>
    </div>
  </div>

  <script>
    // Save
    var textFile = null;
    makeTextFile = function(text) {
      var data = new Blob([text], {type: 'text/json'});

      // If we are replacing a previously generated file we need to
      // manually revoke the object URL to avoid memory leaks.
      if (textFile !== null) {
        window.URL.revokeObjectURL(textFile);
      }

      textFile = window.URL.createObjectURL(data);

      return textFile;
    };

    document.getElementById('save').addEventListener('click', function() {
      var save_data = JSON.stringify(gantt.serialize());
      var link = document.getElementById('download_json');
      link.href = makeTextFile(save_data);
      link.style.display = 'inline';
    }, false);

    // Load
    loadData = function(file) {
      var loaded_filename = file.name.split('.')[0] + '.json';
      var link = document.getElementById('download_json');
      link.download = loaded_filename;
      var reader = new FileReader();
      reader.onload = function(event) {
        try {
          loaded_data = JSON.parse(event.target.result);
          gantt.parse(loaded_data);
        }
        catch (err) {
          gantt.message({type: "error", text: 'Cannot load ' + file.name});
        }
      }
      reader.readAsText(file); // when the file is read it triggers the onload event above
    }

    $("#load_file").change(function() {
      loadData(this.files[0]);
    });
  </script>

  <div id="gantt_here" style='width:100%; height:100%;'></div>

  <style type="text/css">
      .milestone {
          margin-top: 1px;
          width: 5px;
      }
      .gantt_milestone {
        padding-right: 30px;
      }
      .gantt_btn_set.milestone_set {
        text-shadow: 0 -1px 0 #6F6F6F;
        background: mediumvioletred;
        text-shadow: 0 -1px 0 #aa6600;
        color: #fff;
      }
  </style>

  <!-- Config and load data -->
  <script type="text/javascript">
    gantt.config.wide_form = 1;
    gantt.config.order_branch = true;
    gantt.config.fit_tasks = true;
    gantt.config.scale_unit = "month";
    gantt.config.scale_height = 54;
    gantt.config.date_scale = "%F %Y";
    gantt.config.min_column_width = 50;
    gantt.config.subscales = [
      //{unit:"hour", step:3, date:"%H:%i"},
      {unit:"day", step:1, date:"%D %j" }
    ];

    gantt.templates.task_class = function(start, end, task) {
      if (task.milestone) return "gantt_milestone"
      return task.$level == 0 ? "gantt_project" : ""
    };

    gantt.config.lightbox.sections = [
      {name: "description", height: 50, map_to: "text", type: "textarea"},
      {name: "time", height: 72, type: "duration", map_to: "auto"}
    ];

    gantt.locale.labels["milestone"] = "Milestone";
    gantt.config.buttons_left=["dhx_save_btn","dhx_cancel_btn","milestone"];

    gantt.attachEvent("onLightboxButton", function(button_id, node, e) {
        if (button_id == "milestone") {
            var id = gantt.getState().lightbox;
            var task = gantt.getTask(id);
            if (task.milestone) {
              task.end_date = task.cached_end;
              task.type = task.cached_type;
              delete task.cached_type;
              delete task.cached_end;
              delete task.milestone;
            } else {
              task.milestone = true;
              task.cached_type = task.type;
              task.type = gantt.config.types.milestone;
              task.cached_end = task.end_date;
              task.end_date = task.start_date;
            }
            gantt.updateTask(id);
            gantt.hideLightbox();
        }
    });

    gantt.attachEvent("onBeforeTaskChanged", function(id, mode, task) {
      return !task.milestone || mode != 'resize';
    });

    gantt.attachEvent("onAfterTaskUpdate", function(id, item) {
      var task = gantt.getTask(id);
      if (task.milestone && task.start_date != task.end_date) {
        task.end_date = task.start_date;
        gantt.updateTask(id);
      }
    });

    gantt.templates.rightside_text = function(start, end, task) {
      return task.milestone ? task.text : "";
    };

    gantt.init("gantt_here");
  </script>
</body>
</html>